<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="username" content="<%= username %>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Foro Simple</title>
    <link rel="stylesheet" href="/styles/foro.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
    <%- include("partials/header.ejs") %>


    <!-- Main Forum Welcome Banner (only shown when not in a community view) -->
    <div class="community-header" id="main-forum-header">
        <div class="community-banner">
            <div class="community-banner-image" id="main-forum-banner-image">

                <svg viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
                    <!-- Dark background -->
                    <rect width="100%" height="100%" fill="#0D0221" />
                    
                    <!-- Grid pattern -->
                    <g id="grid" stroke="#00FFFF" stroke-width="1" opacity="0.4">
                      <!-- Horizontal lines -->
                      <line x1="0" y1="200" x2="800" y2="200" />
                      <line x1="0" y1="250" x2="800" y2="250" />
                      <line x1="0" y1="300" x2="800" y2="300" />
                      <line x1="0" y1="350" x2="800" y2="350" />
                      
                      <!-- Vertical lines -->
                      <line x1="100" y1="200" x2="100" y2="400" />
                      <line x1="200" y1="200" x2="200" y2="400" />
                      <line x1="300" y1="200" x2="300" y2="400" />
                      <line x1="400" y1="200" x2="400" y2="400" />
                      <line x1="500" y1="200" x2="500" y2="400" />
                      <line x1="600" y1="200" x2="600" y2="400" />
                      <line x1="700" y1="200" x2="700" y2="400" />
                    </g>
                    
                    <!-- Cyberpunk buildings -->
                    <g id="buildings">
                      <!-- Building 1 -->
                      <rect x="50" y="50" width="40" height="150" fill="#290066" />
                      <rect x="55" y="60" width="30" height="10" fill="#FF00FF" opacity="0.8" />
                      <rect x="55" y="80" width="30" height="10" fill="#00FFFF" opacity="0.8" />
                      <rect x="55" y="100" width="30" height="10" fill="#FF00FF" opacity="0.8" />
                      <rect x="55" y="120" width="30" height="10" fill="#00FFFF" opacity="0.8" />
                      <rect x="55" y="140" width="30" height="10" fill="#FF00FF" opacity="0.8" />
                      <rect x="55" y="160" width="30" height="10" fill="#00FFFF" opacity="0.8" />
                      
                      <!-- Building 2 (taller) -->
                      <rect x="150" y="20" width="60" height="180" fill="#290066" />
                      <rect x="160" y="30" width="40" height="8" fill="#00FFFF" opacity="0.7" />
                      <rect x="160" y="48" width="40" height="8" fill="#FF00FF" opacity="0.7" />
                      <rect x="160" y="66" width="40" height="8" fill="#00FFFF" opacity="0.7" />
                      <rect x="160" y="84" width="40" height="8" fill="#FF00FF" opacity="0.7" />
                      <rect x="160" y="102" width="40" height="8" fill="#00FFFF" opacity="0.7" />
                      <rect x="160" y="120" width="40" height="8" fill="#FF00FF" opacity="0.7" />
                      <rect x="160" y="138" width="40" height="8" fill="#00FFFF" opacity="0.7" />
                      <rect x="160" y="156" width="40" height="8" fill="#FF00FF" opacity="0.7" />
                      <rect x="160" y="174" width="40" height="8" fill="#00FFFF" opacity="0.7" />
                      
                      <!-- Building 3 -->
                      <rect x="270" y="80" width="50" height="120" fill="#290066" />
                      <rect x="275" y="90" width="40" height="10" fill="#FF00FF" opacity="0.9" />
                      <rect x="275" y="110" width="40" height="10" fill="#00FFFF" opacity="0.9" />
                      <rect x="275" y="130" width="40" height="10" fill="#FF00FF" opacity="0.9" />
                      <rect x="275" y="150" width="40" height="10" fill="#00FFFF" opacity="0.9" />
                      <rect x="275" y="170" width="40" height="10" fill="#FF00FF" opacity="0.9" />
                      
                      <!-- Building 4 (tallest) -->
                      <rect x="380" y="10" width="70" height="190" fill="#290066" />
                      <rect x="390" y="20" width="50" height="8" fill="#00FFFF" opacity="0.8" />
                      <rect x="390" y="38" width="50" height="8" fill="#FF00FF" opacity="0.8" />
                      <rect x="390" y="56" width="50" height="8" fill="#00FFFF" opacity="0.8" />
                      <rect x="390" y="74" width="50" height="8" fill="#FF00FF" opacity="0.8" />
                      <rect x="390" y="92" width="50" height="8" fill="#00FFFF" opacity="0.8" />
                      <rect x="390" y="110" width="50" height="8" fill="#FF00FF" opacity="0.8" />
                      <rect x="390" y="128" width="50" height="8" fill="#00FFFF" opacity="0.8" />
                      <rect x="390" y="146" width="50" height="8" fill="#FF00FF" opacity="0.8" />
                      <rect x="390" y="164" width="50" height="8" fill="#00FFFF" opacity="0.8" />
                      <rect x="390" y="182" width="50" height="8" fill="#FF00FF" opacity="0.8" />
                      
                      <!-- Building 5 -->
                      <rect x="500" y="60" width="40" height="140" fill="#290066" />
                      <rect x="505" y="70" width="30" height="8" fill="#FF00FF" opacity="0.7" />
                      <rect x="505" y="88" width="30" height="8" fill="#00FFFF" opacity="0.7" />
                      <rect x="505" y="106" width="30" height="8" fill="#FF00FF" opacity="0.7" />
                      <rect x="505" y="124" width="30" height="8" fill="#00FFFF" opacity="0.7" />
                      <rect x="505" y="142" width="30" height="8" fill="#FF00FF" opacity="0.7" />
                      <rect x="505" y="160" width="30" height="8" fill="#00FFFF" opacity="0.7" />
                      <rect x="505" y="178" width="30" height="8" fill="#FF00FF" opacity="0.7" />
                      
                      <!-- Building 6 -->
                      <rect x="600" y="40" width="60" height="160" fill="#290066" />
                      <rect x="610" y="50" width="40" height="10" fill="#00FFFF" opacity="0.9" />
                      <rect x="610" y="70" width="40" height="10" fill="#FF00FF" opacity="0.9" />
                      <rect x="610" y="90" width="40" height="10" fill="#00FFFF" opacity="0.9" />
                      <rect x="610" y="110" width="40" height="10" fill="#FF00FF" opacity="0.9" />
                      <rect x="610" y="130" width="40" height="10" fill="#00FFFF" opacity="0.9" />
                      <rect x="610" y="150" width="40" height="10" fill="#FF00FF" opacity="0.9" />
                      <rect x="610" y="170" width="40" height="10" fill="#00FFFF" opacity="0.9" />
                      
                      <!-- Building 7 -->
                      <rect x="700" y="70" width="50" height="130" fill="#290066" />
                      <rect x="705" y="80" width="40" height="9" fill="#FF00FF" opacity="0.8" />
                      <rect x="705" y="99" width="40" height="9" fill="#00FFFF" opacity="0.8" />
                      <rect x="705" y="118" width="40" height="9" fill="#FF00FF" opacity="0.8" />
                      <rect x="705" y="137" width="40" height="9" fill="#00FFFF" opacity="0.8" />
                      <rect x="705" y="156" width="40" height="9" fill="#FF00FF" opacity="0.8" />
                      <rect x="705" y="175" width="40" height="9" fill="#00FFFF" opacity="0.8" />
                    </g>
                    
                    <!-- Tech circle -->
                    <circle cx="700" cy="60" r="20" fill="#FF00FF" opacity="0.6" />
                    <circle cx="700" cy="60" r="15" fill="#00FFFF" opacity="0.6" />
                    <circle cx="700" cy="60" r="10" fill="#290066" opacity="0.9" />
                    <circle cx="700" cy="60" r="5" fill="#00FFFF" opacity="0.7" />
                    
                    <!-- Circuit lines -->
                    <path d="M30,30 L70,30 L70,60 L100,60" stroke="#00FFFF" stroke-width="2" fill="none" opacity="0.7" />
                    <path d="M670,30 L710,30 L710,60 L750,60" stroke="#FF00FF" stroke-width="2" fill="none" opacity="0.7" />
                  </svg>
            </div>
            <div class="community-banner-overlay"></div>
            <div class="community-tags-banner">
                <span class="community-tag category">Pets</span>
                <span class="community-tag subcategory">Foros</span>
                <span class="community-tag subcategory-extra">Comunidad</span>
            </div>
            <div class="community-info">
                <h1>Bienvenido a Pet-Foros</h1>
                <div class="community-stats">
                    <span><i class="fas fa-users"></i> <span id="total-users"><%= totalUsers %></span> miembros</span>
                    <span><i class="fas fa-comments"></i> <span id="total-posts"><%= totalPosts %></span> publicaciones</span>
                    <span><i class="fas fa-home"></i> <span id="total-communities"><%= totalCommunities %></span> comunidades</span>
                </div>
                <a href="/comunidad" class="btn-join-community">Unirse a una comunidad</a>
            </div>
        </div>
        
        <div class="community-details">
            <div class="accordion-header" onclick="toggleAccordion(this)">
                <h3><i class="fas fa-info-circle"></i> Descripción y Reglas</h3>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
        
            <div class="accordion-content" style="display: none;">
                <div class="community-section">
                    <p id="main-forum-description">Pet-Chan es una comunidad dedicada a crear recuerdos, momentos y experiencias inolvidables junto a tus mascotas. Aquí podrás compartir tus vivencias, buscar consejos y conocer a personas con la misma pasión por los animales.</p>
                </div>
                <div class="community-section">
                    <h4><i class="fas fa-gavel"></i> Reglas</h4>
                    <div id="main-forum-rules">
                        <ol style="color: #333; line-height: 1.5; font-size: 1rem; padding-left: 20px; margin-top: 0;">
                            <li>Tratar a todos los miembros con respeto y amabilidad</li>
                            <li>No se permite contenido ofensivo o discriminatorio</li>
                            <li>No compartir información personal sin consentimiento</li>
                            <li>Las imágenes de mascotas deben ser apropiadas para todos los públicos</li>
                            <li>No hacer spam o publicidad no relacionada con la comunidad</li>
                            <li>Respetar la propiedad intelectual de los demás usuarios</li>
                            <li>Publicar en las categorías adecuadas para mantener el orden</li>
                            <li>No realizar acusaciones sin fundamento contra otros miembros</li>
                            <li>Mantener un lenguaje apropiado en todas las publicaciones</li>
                            <li>Los moderadores tienen la última palabra en caso de conflictos</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Community Header section (shown only in community view) -->
    <div class="community-header" id="community-header" style="display: none;">
        <div class="community-banner">
            <div class="community-banner-image" id="community-banner-image"></div>
            <div class="community-banner-overlay"></div>
            <div class="community-tags-banner" id="community-tags-banner">
                <span id="community-category" class="community-tag category"></span>
                <span id="community-subcategory" class="community-tag subcategory"></span>
                <span id="community-subcategory-extra" class="community-tag subcategory-extra"></span>
            </div>
            <div class="community-info">
                <h1 id="community-title"></h1>
                <div class="community-stats">
                    <span><i class="fas fa-users"></i> <span id="community-members">0</span> miembros</span>
                    <span><i class="fas fa-comments"></i> <span id="community-posts">0</span> publicaciones</span>
                </div>
                <button id="btn-join-community" class="btn-join-community">Unirse a la comunidad</button>
            </div>
        </div>
        
        <div class="community-details">
            <div class="accordion-header" onclick="toggleAccordion(this)">
                <h3><i class="fas fa-info-circle"></i> Descripción y Reglas</h3>
                <i class="fas fa-chevron-down accordion-icon"></i>
            </div>
        
            <div class="accordion-content" style="display: none;">
                <div class="community-section">
                    <p id="community-description"></p>
                </div>
                <div class="community-section">
                    <h4><i class="fas fa-gavel"></i> Reglas</h4>
                    <div id="community-rules"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="top-sections-container">
            <section class="nuevo-mensaje-section">
                <h2 id="form-title">Nuevo Mensaje</h2>
                <div class="formulario-container">
                    <!-- Place this in your mensaje-form -->
                    <form action="/publicar" method="POST" id="mensaje-form" enctype="multipart/form-data">
                        <input type="hidden" id="mensaje-id" name="id" value="">
                        
                        <!-- Add this for community context -->
                        <% if (locals.comunidad_id) { %>
                        <input type="hidden" name="comunidad_id" value="<%= comunidad_id %>">
                        <% } %>
                        
                        <div class="form-group author-field">
                            <div class="autor-container">
                                <span class="autor-label">Autor:</span> 
                                <span class="autor-username"><%= username %></span>
                            </div>
                            <input type="hidden" id="autor" name="autor" value="<%= username %>">
                        </div>
                        
                        
                        
                        <div class="form-group">
                            <div class="field-label">Mensaje:</div>
                            <textarea id="mensaje" name="mensaje" rows="4" required></textarea>
                        </div>

                        <div class="categoria-container">
                            <div class="form-group">
                                <select id="etiqueta-comentario" name="etiqueta">
                                    <option value="">Seleccione categoría</option>
                                    <% etiquetasDisponibles.forEach(etiqueta => { %>
                                        <option value="<%= etiqueta %>"><%= etiqueta %></option>
                                    <% }); %>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <select id="subcategoria-comentario" name="subcategoria">
                                    <option value="">Seleccione subcategoría</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <select id="extrasubcategoria-comentario" name="extrasubcategoria">
                                    <option value="">Seleccione subcategoría extra</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group imagenes-input-container">
                            <div id="drop-zone" class="drop-zone">
                                <label for="imagenes-input" class="imagenes-input-label">
                                    <i class="fas fa-images"></i> Seleccionar imágenes
                                </label>
                            </div>
                            <input type="file" id="imagenes-input" name="imagenes" class="imagenes-input" accept="image/*" multiple>
                            <div id="imagenes-preview-container"></div>
                            <p class="hint-text">Máximo 9 imágenes por mensaje</p>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="submit" id="submit-btn">Publicar</button>
                            <button type="button" id="cancel-btn" class="cancel-message-btn">Cancelar</button>
                        </div>
                    </form>
                </div>
            </section>
            
            <!-- Nuevo Comentario Section -->
            <section class="nuevo-comentario-section" style="display: none;">
                <h2 id="form-comment-title">Nuevo Comentario</h2>
                <div class="formulario-container">
                    <form action="/publicar-comentario" method="POST" id="comentario-form" enctype="multipart/form-data">
                        <input type="hidden" id="mensaje-padre-id" name="mensaje_padre_id" value="">
                        <div class="form-group author-field">
                            <div class="autor-container">
                                <span class="autor-label">Autor:</span> 
                                <span class="autor-username"><%= username %></span>
                            </div>
                            <input type="hidden" id="autor" name="autor" value="<%= username %>">
                        </div>
                        
                        
                        
                        
                        <div class="form-group">
                            <div class="field-label">Comentario:</div>
                            <textarea id="comentario" name="comentario" rows="9" required></textarea>
                        </div>
                        
                        <div class="form-group imagenes-input-container">
                            <div id="drop-zone-comentario" class="drop-zone">
                                <label for="imagenes-input-comentario" class="imagenes-input-label">
                                    <i class="fas fa-images"></i> Seleccionar imágenes
                                </label>
                            </div>
                            <input type="file" id="imagenes-input-comentario" name="imagenes" class="imagenes-input" accept="image/*" multiple>
                            <div id="imagenes-preview-container-comentario"></div>
                            <p class="hint-text">Máximo 9 imágenes por comentario</p>
                        </div>
                        
                        <div class="form-buttons">
                            <button type="submit" id="submit-comentario-btn">Publicar Comentario</button>
                            <button type="button" id="cancel-comentario-btn">Cancelar</button>
                        </div>
                    </form>
                </div>
            </section>
            
            <section class="filtros-section">
                <div class="filtros-container">
                    <div class="filtros-header">
                        <div class="filtros-buttons">
                            <button id="btn-orden" class="filtro-boton">Orden</button>
                            <button id="btn-ranking" class="filtro-boton">Ranking</button>
                            <button id="btn-tipo" class="filtro-boton">Tipo</button>
                            <button id="btn-etiquetas" class="filtro-boton">Etiquetas</button>
                            <button id="btn-subetiquetas" class="filtro-boton">Subetiquetas</button>
                            <button id="btn-comunidad" class="filtro-boton">Comunidad</button>
                        </div>
                        <div>
                            <button id="aplicar-filtros" class="filtro-boton">Aplicar filtros</button>
                            <button id="limpiar-filtros" class="filtro-boton">Limpiar filtros</button>
                        </div>
                    </div>
                    
                    <!-- Sección unificada de filtros de comunidad -->
                    <div id="filtros-comunidad" class="filtros-expanded" style="display: none;">
                        <h3>Filtrar por comunidad</h3>
                        
                        <!-- Opción para todas las comunidades -->
                        <div class="filtro-item filtro-destacado">
                            <input type="radio" id="comunidad-todas" name="comunidad_id" value="" 
                                <%= (locals.filtros && (!filtros.comunidadId && !filtros.misComunidades)) ? 'checked' : '' %>>
                            <label for="comunidad-todas">Todas las comunidades</label>
                        </div>
                        
                        <div class="filtros-separator">Mis comunidades</div>
                        
                        <!-- Listado de comunidades del usuario -->
                        <div id="mis-comunidades-container" class="filtros-grid">
                            <% if (locals.userCommunities && userCommunities.length > 0) { %>
                                <% userCommunities.forEach(comunidad => { %>
                                    <div class="filtro-item">
                                        <input type="radio" id="comunidad-user-<%= comunidad.id %>" name="comunidad_id" value="<%= comunidad.id %>" 
                                            <%= (locals.filtros && filtros.comunidadId == comunidad.id) ? 'checked' : '' %>>
                                        <label for="comunidad-user-<%= comunidad.id %>"><%= comunidad.nombre %></label>
                                    </div>
                                <% }); %>
                            <% } else { %>
                                <p class="filtro-mensaje">No perteneces a ninguna comunidad todavía</p>
                            <% } %>
                        </div>
                    </div>

                    <form id="filter-form" action="/filtrar" method="GET">
                        <!-- Orden Filters -->
                        <div id="filtros-orden" class="filtros-expanded">
                            <div class="filtros-grid">
                                <% const ordenOpciones = [
                                    { id: 'recientes', valor: 'recientes', texto: 'Más recientes' },
                                    { id: 'antiguos', valor: 'antiguos', texto: 'Más antiguos' },
                                    { id: 'nuevos_24h', valor: 'nuevos_24h', texto: 'Nuevos (24h)' },
                                    { id: 'nuevos_semana', valor: 'nuevos_semana', texto: 'Nuevos (semana)' },
                                    { id: 'mas_valorados', valor: 'mas_valorados', texto: 'Mejor valorados' }
                                ]; %>
                                <% ordenOpciones.forEach(opcion => { %>
                                    <div class="filtro-item">
                                        <input type="radio" id="<%= opcion.id %>" name="orden" value="<%= opcion.valor %>">
                                        <label for="<%= opcion.id %>"><%= opcion.texto %></label>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    
                        <!-- Ranking Filters -->
                        <div id="filtros-ranking" class="filtros-expanded">
                            <div class="filtros-grid">
                                <% const rankingOpciones = [
                                    { id: 'todos_ranking', valor: 'todos', texto: 'Todos' },
                                    { id: 'populares', valor: 'populares', texto: 'Populares (+100 likes)' },
                                    { id: 'medios', valor: 'medios', texto: 'Medios (20-99 likes)' },
                                    { id: 'menos_populares', valor: 'menos_populares', texto: 'Menos populares (0-19)' }
                                ]; %>
                                <% rankingOpciones.forEach(opcion => { %>
                                    <div class="filtro-item">
                                        <input type="radio" id="<%= opcion.id %>" name="ranking" value="<%= opcion.valor %>">
                                        <label for="<%= opcion.id %>"><%= opcion.texto %></label>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    
                        <!-- Tipo Filters -->
                        <div id="filtros-tipo" class="filtros-expanded">
                            <div class="filtros-grid">
                                <% const tipoOpciones = [
                                    { id: 'todos_tipo', valor: 'todos', texto: 'Todos los mensajes' },
                                    { id: 'mios', valor: 'mios', texto: 'Mis mensajes' },
                                ]; %>
                                <% tipoOpciones.forEach(opcion => { %>
                                    <div class="filtro-item">
                                        <input type="radio" id="<%= opcion.id %>" name="tipo" value="<%= opcion.valor %>">
                                        <label for="<%= opcion.id %>"><%= opcion.texto %></label>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    
                        <!-- Etiquetas Filters -->
                        <div id="filtros-etiquetas" class="filtros-expanded">
                            <div class="filtros-grid">
                                <% etiquetasDisponibles.forEach(etiqueta => { %>
                                    <div class="filtro-item">
                                        <input type="checkbox" id="filtro-<%= etiqueta.toLowerCase().replace(/\s+/g, '-') %>" name="etiquetas" value="<%= etiqueta %>">
                                        <label for="filtro-<%= etiqueta.toLowerCase().replace(/\s+/g, '-') %>"><%= etiqueta %></label>
                                    </div>
                                <% }); %>
                            </div>
                        </div>
                    
                        <!-- Subetiquetas Filters - Cargado dinámicamente -->
                        <div id="filtros-subetiquetas" class="filtros-expanded">
                            <div class="filtros-grid" id="subetiquetas-grid">
                                <!-- Se cargará dinámicamente con JS basado en las etiquetas seleccionadas -->
                                <div class="filtro-item initial-option">
                                    <input type="checkbox" id="filtro-ninguna-sub" name="subetiquetas" value="Ninguna">
                                    <label for="filtro-ninguna-sub">Ninguna</label>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Extrasubetiquetas Filters - Añadido al filtro -->
                        <div id="filtros-extrasubetiquetas" class="filtros-expanded">
                            <div class="filtros-grid" id="extrasubetiquetas-grid">
                                <!-- Se cargará dinámicamente con JS basado en las subetiquetas seleccionadas -->
                                <div class="filtro-item">
                                    <input type="checkbox" id="filtro-ninguna-extra" name="extrasubetiquetas" value="Ninguna">
                                    <label for="filtro-ninguna-extra">Ninguna</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </section>

            <section class="mensajes">
                <h2>Número total de publicaciones encontrados: (<span id="contador"><%= mensajes.length %></span>)</h2>
                <div class="lista-mensajes">
                    <% if (mensajes.length === 0) { %>
                        <p class="no-mensajes">No hay mensajes aún. ¡Sé el primero en publicar!</p>
                    <% } else { %>
                        <% mensajes.forEach(mensaje => { %>
                            <div class="mensaje" 
                            data-id="<%= mensaje.id %>" 
                            data-user-id="<%= mensaje.user_id %>" 
                            data-comunidad-id="<%= mensaje.comunidad_id || '' %>">
                            
                            <!-- Cabecera con autor y botones de acción en la misma línea -->
                            <div class="mensaje-cabecera">
                                <span class="autor"><%= mensaje.autor %></span>
                                <div class="mensaje-acciones">
                                    <% if (mensaje.autor === username) { %>
                                        <button class="btn-editar" data-id="<%= mensaje.id %>"><i class="fas fa-edit"></i></button>
                                        <button class="btn-eliminar" data-id="<%= mensaje.id %>"><i class="fas fa-trash"></i></button>
                                    <% } %>
                                    <button class="btn-comentar" data-id="<%= mensaje.id %>"><i class="fas fa-comment"></i></button>
                                </div>
                            </div>
                            <div class="rangos-wrapper">
                                <div class="rango-item"><span class="rango-valor">${mensaje.rango1 || 'Novato'}</span></div>
                                <div class="rango-item ${!mensaje.rango2 ? 'rango-vacio' : ''}"><span class="rango-valor">${mensaje.rango2 || ''}</span></div>
                                <div class="rango-item ${!mensaje.rango3 ? 'rango-vacio' : ''}"><span class="rango-valor">${mensaje.rango3 || ''}</span></div>
                              </div>
                              
                              
                            <div class="etiquetas-container">
                                <div class="etiquetas-wrapper">
                                    <% if (mensaje.etiqueta) { %>
                                        <span class="etiqueta principal" data-categoria="<%= mensaje.etiqueta %>">
                                            <%= mensaje.etiqueta %>
                                        </span>
                                    <% } %>
                                    <% if (mensaje.subcategoria) { %>
                                        <span class="subetiqueta" 
                                            data-categoria="<%= mensaje.etiqueta %>"
                                            data-subcategoria="<%= mensaje.subcategoria %>">
                                            <%= mensaje.subcategoria %>
                                        </span>
                                    <% } %>
                                    <% if (mensaje.extrasubcategoria) { %>
                                        <span class="subetiqueta extra" 
                                            data-categoria="<%= mensaje.etiqueta %>"
                                            data-extrasubcategoria="<%= mensaje.extrasubcategoria %>">
                                            <%= mensaje.extrasubcategoria %>
                                        </span>
                                    <% } %>
                                </div>
                            </div>
                            
                            <div class="mensaje-contenido"><%= mensaje.mensaje %></div>
                            
                            <% if (mensaje.imagenes && mensaje.imagenes.length > 0) { %>
                                <div class="mensaje-imagenes">
                                    <% mensaje.imagenes.forEach(imagen => { %>
                                        <div class="imagen-mensaje">
                                            <img src="<%= imagen.url %>" alt="Imagen adjunta">
                                        </div>
                                    <% }); %>
                                </div>
                            <% } %>
                            
                            <div class="mensaje-pie">
                                <div class="ranking-container" data-mensaje-id="<%= mensaje.id %>">
                                    <button class="btn-votar upvote" data-valor="1">
                                        &#x2191;
                                    </button>
                                    <span class="ranking-valor <%= mensaje.ranking < 0 ? 'negativo' : '' %>">
                                        <%= mensaje.ranking %>
                                    </span>
                                    <button class="btn-votar downvote" data-valor="-1">
                                        &#x2193;
                                    </button>
                                </div>
                                <span class="fecha mensaje-fecha-pie"><%= mensaje.fechaStr %></span>
                            </div>
                            
                      
                            <!-- Sección de comentarios -->
                            <div class="comentarios-seccion">
                                <div class="comentarios-lista">
                                    <% if (mensaje.comentarios && mensaje.comentarios.length > 0) { %>
                                        <% mensaje.comentarios.forEach(comentario => { %>
                                            <div class="comentario" data-id="<%= comentario.id %>" data-user-id="<%= comentario.user_id %>">
                                                <div class="comentario-cabecera">
                                                    <span class="comentario-autor"><%= comentario.autor %></span>
                                                    <div class="comentario-acciones">
                                                        <% if (comentario.autor === username) { %>
                                                            <button class="btn-editar-comentario" data-id="<%= comentario.id %>" data-mensaje-id="<%= mensaje.id %>">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="btn-eliminar-comentario" data-id="<%= comentario.id %>" data-mensaje-id="<%= mensaje.id %>">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        <% } %>
                                                    </div>
                                                </div>
                                                <div class="comentario-contenido"><%= comentario.comentario %></div>

                                                <!-- Images section remains unchanged -->
                                                <% if (comentario.imagenes && comentario.imagenes.length > 0) { %>
                                                    <div class="comentario-imagenes">
                                                        <% comentario.imagenes.forEach(imagen => { %>
                                                            <div class="imagen-comentario">
                                                                <img src="<%= imagen.url %>" alt="Imagen de comentario">
                                                            </div>
                                                        <% }); %>
                                                    </div>
                                                <% } %>

                                                <!-- New footer layout -->
                                                <div class="comentario-pie">
                                                    <span class="comentario-fecha"><%= comentario.fechaStr %></span>
                                                    <% if (comentario.autor === username) { %>
                                                    <div class="comentario-botones">

                                                    </div>
                                                    <% } %>
                                                </div>
                                            </div>
                                        <% }); %>
                                    <% } %>
                                </div>
                                <div class="nuevo-comentario-container">
                                    <form class="nuevo-comentario-form" data-mensaje-id="<%= mensaje.id %>">
                                        <div class="form-group author-field">
                                            <div class="field-label">Autor:</div>
                                            <div class="autor-display"><%= username %></div>
                                            <input type="hidden" name="autor" value="<%= username %>">
                                        </div>
                                        <div class="form-group">
                                            <div class="field-label">Comentario:</div>
                                            <textarea 
                                                name="comentario" 
                                                placeholder="Escribe tu comentario" 
                                                required></textarea>
                                        </div>
                                        <div class="form-group imagenes-input-container">
                                            <div class="drop-zone-comentario">
                                                <label for="imagenes-comentario-<%= mensaje.id %>" class="imagenes-input-label">
                                                    <i class="fas fa-images"></i> Seleccionar imágenes
                                                </label>
                                            </div>
                                            <input 
                                                type="file" 
                                                id="imagenes-comentario-<%= mensaje.id %>" 
                                                name="imagenes" 
                                                class="imagenes-input" 
                                                accept="image/*" 
                                                multiple>
                                            <div class="imagenes-preview-container"></div>
                                            <p class="hint-text">Máximo 9 imágenes por comentario</p>
                                        </div>
                                        <div class="form-actions">
                                            <button type="submit" class="btn-publicar">Publicar comentario</button>
                                            <button type="button" class="btn-cancelar">Cancelar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <% }); %>
                    <% } %>
                </div>
            </section>
        </div>
    </div>
                
<!-- Modal para confirmar eliminación de mensaje -->
<div id="modal-confirmacion" class="modal">
    <div class="modal-contenido">
      <i class="fas fa-exclamation-triangle warning-icon"></i>
      <p>¿Estás seguro de que deseas eliminar este mensaje?</p>
      <p class="modal-subtitle">Esta acción no se puede deshacer.</p>
      <div class="modal-botones">
        <button id="btn-confirmar-eliminar">Eliminar</button>
        <button id="btn-cancelar-eliminar">Cancelar</button>
      </div>
    </div>
  </div>
  
  <!-- Modal para confirmar eliminación de comentario -->
  <div id="modal-confirmacion-comentario" class="modal">
    <div class="modal-contenido">
      <i class="fas fa-exclamation-triangle warning-icon"></i>
      <p>¿Estás seguro de que deseas eliminar este comentario?</p>
      <p class="modal-subtitle">Esta acción no se puede deshacer.</p>
      <div class="modal-botones">
        <button id="btn-confirmar-eliminar-comentario">Eliminar</button>
        <button id="btn-cancelar-eliminar-comentario">Cancelar</button>
      </div>
    </div>
  </div>
        
                
                <script src="/scripts/foro.js"></script>

                <script>
                    window.addEventListener('load', function () {
                      const boton = document.getElementById('aplicar-filtros');
                      if (boton) {
                        boton.click();
                      }
                    });
                  </script>
                  
                <%- include("partials/footer.ejs") %>
                </body>
                </html>